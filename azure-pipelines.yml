trigger:
  - 'None'

pool:
  name: 'Self-hosted'

variables:
  - group: ServicePrincipalSecrets

steps:
  # Ensure that the repository is checked out
  - checkout: self
    displayName: 'Checkout Repository'

  # Step to update a dummy file with timestamp using Bash in WSL
  - task: Bash@3
    inputs:
      targetType: 'inline'
      script: |
        # Convert Windows-style path to WSL path
        repo_dir=$(cygpath -u "$(Build.SourcesDirectory)")
        cd "$repo_dir" # Ensure we are in the repository directory
        echo "This is a dummy file updated at $(date +'%Y-%m-%d %H:%M:%S')" >> dummy.txt
    displayName: 'Update Dummy File with Timestamp'

  # Commit the updated dummy file using Bash in WSL
  - task: Bash@3
    inputs:
      targetType: 'inline'
      script: |
        repo_dir=$(cygpath -u "$(Build.SourcesDirectory)")
        cd "$repo_dir" # Ensure we are in the repository directory
        git config --global user.email "your-email@example.com"
        git config --global user.name "Your Name"
        
        git add dummy.txt
        git commit -m "Updated dummy file at $(date +'%Y-%m-%d %H:%M:%S')"
        git push origin $(Build.SourceBranch)
    displayName: 'Commit and Push Changes'

  # Task to check and update/create PR using Bash in WSL
  - task: Bash@3
    env:
      AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)
    inputs:
      targetType: 'inline'
      script: |
        echo "Running az login with System.AccessToken"
        az extension add --name azure-devops

        # Capturing the source branch and removing 'refs/heads/'
        sourceBranch="$(Build.SourceBranch)"
        sourceBranch=${sourceBranch#refs/heads/}
        
        targetBranch="master"

        # Get current timestamp
        timestamp=$(date +'%Y-%m-%d %H:%M:%S')

        echo "Source Branch: $sourceBranch"
        echo "Target Branch: $targetBranch"
        echo "Current Timestamp: $timestamp"

        # Check if an active pull request exists
        existingPR=$(az repos pr list --organization https://dev.azure.com/kamilsaiyed/ \
                                      --project "KamilSaiyed" \
                                      --repository "KamilSaiyed" \
                                      --source-branch "$sourceBranch" \
                                      --target-branch "$targetBranch" \
                                      --status "active" \
                                      --query '[0].pullRequestId' \
                                      --output tsv)

        if [[ -n "$existingPR" ]]; then
          echo "Updating existing pull request with ID: $existingPR"
          az repos pr update --organization https://dev.azure.com/kamilsaiyed/ \
                             --id "$existingPR" \
                             --title "Updated PR for $sourceBranch at $timestamp" \
                             --description "This PR was updated by the pipeline at $timestamp."
        else
          echo "No active PR found. Creating a new one."
          az repos pr create --organization https://dev.azure.com/kamilsaiyed/ \
                             --project "KamilSaiyed" \
                             --repository "KamilSaiyed" \
                             --source-branch "$sourceBranch" \
                             --target-branch "$targetBranch" \
                             --title "Automated PR for $sourceBranch at $timestamp" \
                             --description "This PR was created by the pipeline at $timestamp."
    displayName: 'Update or Create Pull Request'
